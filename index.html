<!DOCTYPE html>
<html>
  <head>
    <title>Doxer</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" media="all" href="doxer.css">
  </head>
  <body>
    <div id="container">
      <table cellpadding="0" cellspacing="0">
        <thead>
          <tr>
            <th class="docs">
              <h1>
                Doxer
              </h1>
            </th>
            <th class="code">
            </th>
          </tr>
        </thead>
        <tbody>
          
            <tr id="section-1">
              <td class="docs">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <pre><code class="top">/*!
 * Doxer
 * Copyright(c) 2012 Fredrik Forsmo &lt;fredrik.forsmo@gmail.com&gt;
 * MIT Licensed
 */</code></pre>
              </td>
              <td class="code">
                <pre><span class="keyword">var</span> fs = require(<span class="string">'fs'</span>)
  , dox = require(<span class="string">'dox'</span>)
  , ejs = require(<span class="string">'ejs'</span>)
  , exec = require(<span class="string">'child_process'</span>).exec
  , utils = require(<span class="string">'./utils'</span>)
  , coffee = <span class="literal">false</span>;</pre>
              </td>
            </tr>
          
            <tr id="section-2">
              <td class="docs">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
                </div>
                <p>Doxer version.</p>
              </td>
              <td class="code">
                <pre>exports.version = <span class="string">'0.1.4'</span>;</pre>
              </td>
            </tr>
          
            <tr id="section-3">
              <td class="docs">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>Process all files</p>
              </td>
              <td class="code">
                <pre>exports.process = <span class="function"><span class="keyword">function</span> <span class="params">(options, callback)</span> {</span>
  <span class="keyword">var</span> template = fs.readFileSync(__dirname + <span class="string">'/../resources/doxer.ejs'</span>, <span class="string">'utf8'</span>).toString()
    , style = fs.readFileSync(__dirname + <span class="string">'/../resources/doxer.css'</span>, <span class="string">'utf8'</span>).toString()
    , html
    , sections = [];

  <span class="keyword">if</span> (<span class="keyword">typeof</span> options.files === <span class="string">'string'</span>) {
    options.files = [options.files];
  }

  options.files.sort().forEach(<span class="function"><span class="keyword">function</span> <span class="params">(file)</span> {</span>
    <span class="keyword">if</span> (file.indexOf(<span class="string">'.js'</span>) !== -<span class="number">1</span> || file.indexOf(<span class="string">'.coffee'</span>) !== -<span class="number">1</span>) {
      <span class="keyword">if</span> (file.indexOf(<span class="string">'.coffee'</span>) !== -<span class="number">1</span>) coffee = <span class="literal">true</span>;
      
      file = fs.readFileSync(file, <span class="string">'utf8'</span>).toString();
    }
    
    sections = generate(sections, file);
  });
  
  <span class="comment">// Render template with sections and title </span>
  html = ejs.render(template, {
    title: options.title,
    sections: sections
  });
  
  <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) {
    callback({ html: html, style: style });
  } <span class="keyword">else</span> {
    exec(<span class="string">'mkdir -p '</span> + options.dir, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      fs.writeFile(options.dir + <span class="string">'/doxer.html'</span>, html);
      fs.writeFile(options.dir + <span class="string">'/doxer.css'</span>, style);
    });
  }
}</pre>
              </td>
            </tr>
          
            <tr id="section-4">
              <td class="docs">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>Extract top comments from source</p>
              </td>
              <td class="code">
                <pre><span class="function"><span class="keyword">function</span> <span class="title">extractTopComment</span> <span class="params">(source)</span> {</span>
  <span class="keyword">var</span> topComment = <span class="regexp">/(\/\*\!(.|\n)+?\*\/)/</span>.exec(source)
    , lineComment = <span class="regexp">/\/\/.*$/m</span>
    , comment = <span class="string">''</span>
    , result = {};
  
  <span class="keyword">if</span> (topComment !== <span class="literal">null</span> &amp;&amp; topComment[<span class="number">1</span>]) {
    comment = utils.escape(topComment[<span class="number">1</span>]);
    topComment = topComment[<span class="number">1</span>];
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> lines = source.split(<span class="string">'\n'</span>);
    topComment = <span class="string">''</span>;
    
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lines.length; i++) {
      <span class="keyword">if</span> (lineComment.test(lines[i])) {
        topComment += lines[i] + <span class="string">'\n'</span>;
      } <span class="keyword">else</span> {
        <span class="comment">// Let's check for a comment on the next line, maybe it's a empty new line between.</span>
        <span class="keyword">if</span> (lineComment.test(lines[i + <span class="number">1</span>])) <span class="keyword">continue</span>;
        <span class="keyword">break</span>;
      }
    }
    
    comment = utils.escape(topComment);
  }
  
  <span class="keyword">if</span> (topComment &amp;&amp; comment) {
    result = {
      docs_html: <span class="string">'&lt;pre>&lt;code class="top">'</span> + comment + <span class="string">'&lt;/code>&lt;/pre>'</span>,
      code_html: readUntilDox(source, topComment)
    };
  }
  
  <span class="keyword">return</span> result; 
}</pre>
              </td>
            </tr>
          
            <tr id="section-5">
              <td class="docs">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
                </div>
                <p>Generate documentation html and code html for <code>source</code></p>
              </td>
              <td class="code">
                <pre><span class="function"><span class="keyword">function</span> <span class="title">generate</span> <span class="params">(sections, source)</span> {</span>
  <span class="keyword">var</span> parsed
    , topComment;
    
  sections = sections || [];
  
  <span class="comment">// Replacing CoffeeScript ###*/### with Dox syntax</span>
  source = utils.toDox(source);
  
  <span class="comment">// Parsing Dox comments</span>
  parsed = dox.parseComments(source, { raw: <span class="literal">false</span> });
  
  <span class="comment">// Extract top comment</span>
  comment = extractTopComment(source);
  
  <span class="keyword">if</span> (comment.docs_html !== <span class="literal">undefined</span>) {
    sections.push(comment);
  }
        
  parsed.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    <span class="keyword">if</span> (doc.ignore || doc.isPrivate) <span class="keyword">return</span>;
                
    sections.push({
      docs_html: doc.description.full,
      code_html: utils.highlight(coffee, doc.code)
    });
  });
  
  <span class="keyword">return</span> sections;
}</pre>
              </td>
            </tr>
          
            <tr id="section-6">
              <td class="docs">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>Read until dox syntax starts</p>
              </td>
              <td class="code">
                <pre><span class="function"><span class="keyword">function</span> <span class="title">readUntilDox</span> <span class="params">(src, comment)</span> {</span>
  <span class="keyword">var</span> res = <span class="string">''</span>
    , lines = src.split(<span class="string">'\n'</span>);
        
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lines.length; i++) {
    <span class="comment">// Regex instead of indexOf fixes so dox don't break here.</span>
    <span class="keyword">if</span> (<span class="regexp">/\*\*/</span>.test(lines[i])) {
      <span class="keyword">break</span>;
    } <span class="keyword">else</span> {
      res += lines[i] + <span class="string">'\n'</span>;
    }
  }
  
  res = res.replace(comment, <span class="string">''</span>);

  <span class="keyword">return</span> utils.highlight(coffee, res.trim());
}</pre>
              </td>
            </tr>
          
        </tbody>
      </table>
    </div>
  <body>
</html>
